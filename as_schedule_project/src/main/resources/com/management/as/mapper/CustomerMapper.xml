<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.management.as.mapper.CustomerMapper">
	<!-- 회원가입 -->
	<insert id="join" >
	INSERT INTO user
	(
		user_id,
		password,
		username,
		phone,
		address,
		detail
	)
	VALUES (
		#{user_id},
		#{password},
		#{username},
		#{phone},
		#{address},
		#{detail}
	) 
	</insert>
	
	<select id="findByUserId" resultType="com.management.as.domain.UserVO" parameterType="String">
	    SELECT 
	    	uid,
	    	user_id,
	    	username,
	    	password,
	    	phone,
	    	address,
	    	detail
	    FROM user WHERE user_id = #{user_id}
	</select>
	
	<select id="idCheck" resultType="int">
		SELECT COUNT(*) FROM user
		WHERE user_id = #{id}
	</select>

	<!-- 해당 사용자의 AS 현황 목록 -->
	<!-- 변수 초기화 쿼리 -->
	<update id="initRowNum">
	  SET @rownum := 0;
	</update>

	<select id="list" resultType="com.management.as.domain.CustomerVO" >
	SELECT
		@rownum := IFNULL(@rownum, 0) + 1 AS rownum,
		c.cnum,
	    c.uid,
	    c.model,
	    c.issue,
	    c.detail,
	    c.visitdate,
	    c.visitend,
	    c.yn,
	    c.prostatus,
	    c.star,
	    c.regdate,
	    c.proname,
	    c.visittime,
	    c.comment,
	    u.user_id,
	    u.username,
	    u.phone,
	    u.address,
	    u.detail AS user_detail
	FROM customer c JOIN user u ON c.uid = u.uid
	WHERE u.user_id = #{user_id}
	<!-- 검색 조건 -->
	<if test="type != null and keyword != null and type == 'proname'">
        AND c.proname LIKE CONCAT('%', #{keyword}, '%')
    </if>
    <if test="type != null and keyword != null and type == 'issue'">
        AND c.issue LIKE CONCAT('%', #{keyword}, '%')
    </if>

    <if test="status_keyword != null and status_keyword != ''">
        AND c.prostatus = #{status_keyword}
    </if>
	ORDER BY c.cnum DESC
	LIMIT #{pageSize} OFFSET #{offset}
	</select>

	<!-- 전체 게시글 개수 -->
	<select id="totalCount" resultType="int">
		SELECT 
			COUNT(*) 
		FROM customer c JOIN user u ON c.uid = u.uid
		WHERE u.user_id = #{user_id}
		<!-- 검색 조건 -->
		<if test="type != null and keyword != null and type == 'proname'">
	        AND c.proname LIKE CONCAT('%', #{keyword}, '%')
	    </if>
	    <if test="type != null and keyword != null and type == 'issue'">
	        AND c.issue LIKE CONCAT('%', #{keyword}, '%')
	    </if>

	    <if test="status_keyword != null and status_keyword != ''">
	        AND c.prostatus = #{status_keyword}
	    </if>
	</select>
	
	<select id="get" resultType="com.management.as.domain.CustomerVO">
	SELECT
		cnum,
	    uid,
	    model,
	    issue,
	    detail,
	    visitdate,
	    visitend,
	    yn,
	    prostatus,
	    star,
	    regdate,
	    proname,
	    visittime,
	    comment
	WHERE cnum = #{cnum}
	</select>
	
	<!-- 제품 목록 -->
	<select id="productList" resultType="com.management.as.domain.ProductVO">
	SELECT
		pno, category, proname
	FROM product
	</select>
	
	<!-- AS 접수 -->
	<insert id="register">
	INSERT INTO customer
	(
		uid,
		model,
		issue,
		detail,
		visitdate,
		yn,
		proname,
		visittime
	)
	VALUES (
		#{uid},
		#{model},
		#{issue},
		#{detail},
		#{visitdate},
		#{yn},
		#{proname},
		#{visittime}
	)
	</insert>
	
	<!-- 후기 등록 -->
	<update id="update">
		UPDATE customer SET
		star = #{star}, comment = #{comment}
		WHERE cnum = #{cnum}
	</update>
	
	
	
	
	
	    <!-- ✅ 전체 리스트 조회 (검색, 페이징 포함) -->
<select id="alllist" resultType="com.management.as.domain.CustomerVO">
    SELECT
        @rownum := @rownum + 1 AS rownum,
        sub.cnum,
        sub.uid,
        sub.model,
        sub.issue,
        sub.detail,
        sub.visitdate,
        sub.visitend,
        sub.yn,
        sub.prostatus,
        sub.star,
        sub.regdate,
        sub.proname,
        sub.visittime,
        sub.comment,
        sub.user_id,
        sub.username,
        sub.phone,
        sub.address,
        sub.user_detail
    FROM (
        SELECT
            c.cnum,
            c.uid,
            c.model,
            c.issue,
            c.detail,
            c.visitdate,
            c.visitend,
            c.yn,
            c.prostatus,
            c.star,
            c.regdate,
            c.proname,
            c.visittime,
            c.comment,
            u.user_id,
            u.username,
            u.phone,
            u.address,
            u.detail AS user_detail
        FROM customer c
        JOIN user u ON c.uid = u.uid
        WHERE 1 = 1
            <if test="type != null and keyword != null and type == 'proname'">
                AND c.proname LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="type != null and keyword != null and type == 'issue'">
                AND c.issue LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="type != null and keyword != null and type == 'username'">
                AND u.username LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="status_keyword != null and status_keyword != ''">
                AND c.prostatus = #{status_keyword}
            </if>
        ORDER BY
            CASE
                WHEN c.prostatus = 'W' THEN 1
                WHEN c.prostatus = 'P' THEN 2
                WHEN c.prostatus = 'F' THEN 3
                ELSE 4
            END
        LIMIT #{pageSize} OFFSET #{offset}
    ) AS sub,
    (SELECT @rownum := 0) AS r
</select>

    <!-- ✅ 전체 데이터 수 (페이징용 카운트) -->
    <select id="alltotalCount" resultType="int">
        SELECT COUNT(*)
        FROM customer c
        JOIN user u ON c.uid = u.uid
        WHERE 1 = 1
            <if test="type != null and keyword != null and type == 'proname'">
                AND c.proname LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="type != null and keyword != null and type == 'issue'">
                AND c.issue LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="type != null and keyword != null and type == 'username'">
        		AND u.username LIKE CONCAT('%', #{keyword}, '%')
    		</if>
            <if test="status_keyword != null and status_keyword != ''">
                AND c.prostatus = #{status_keyword}
            </if>
    </select>

    <!-- ✅ 특정 고객 정보 가져오기 -->
    <select id="get2" resultType="com.management.as.domain.CustomerVO">
        SELECT
            cnum,
            uid,
            model,
            issue,
            detail,
            visitdate,
            visitend,
            yn,
            prostatus,
            star,
            regdate,
            proname,
            visittime,
            comment
        FROM customer
        WHERE cnum = #{cnum}
    </select>

    <!-- ✅ 제품 목록 조회 -->
    <select id="productList2" resultType="com.management.as.domain.ProductVO">
        SELECT
            pno,
            category,
            proname
        FROM product
    </select>
	
	<!-- enddate -->
	<update id="updateEndDate">
	  UPDATE customer
    SET visitend = #{endDate}, emp_comment = #{cmt}, prostatus = 'F'
    WHERE cnum = #{cnum}
	</update>

</mapper>